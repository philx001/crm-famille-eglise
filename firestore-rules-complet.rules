rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      let userData = getUserData();
      let roles = ['disciple', 'nouveau', 'mentor', 'adjoint_berger', 'berger', 'admin'];
      return roles.indexOf(userData.role) >= roles.indexOf(role);
    }

    function belongsToFamily(familleId) {
      let userData = getUserData();
      return userData.role == 'admin' || userData.famille_id == familleId;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    // FAMILLES : lecture sans auth pour la page de connexion (recherche par nom)
    match /familles/{familleId} {
      allow read: if request.auth == null || (isAuthenticated() && belongsToFamily(familleId));
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // UTILISATEURS
    match /utilisateurs/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin() ||
        (hasRole('berger') && resource.data.famille_id == getUserData().famille_id) ||
        (hasRole('mentor') && resource.data.mentor_id == request.auth.uid) ||
        (resource.data.famille_id == getUserData().famille_id)
      );

      // Création : l'utilisateur peut créer son propre document (après inscription via createUserWithEmailAndPassword)
      // L'app contrôle les données (rôle, famille_id, etc.)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        (hasRole('berger') && resource.data.famille_id == getUserData().famille_id) ||
        isAdmin()
      );

      allow delete: if isAuthenticated() && (
        (hasRole('berger') && resource.data.famille_id == getUserData().famille_id) ||
        isAdmin()
      );
    }

    // PROGRAMMES
    match /programmes/{programmeId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create, update: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow delete: if isAuthenticated() &&
        (hasRole('berger') || isAdmin()) &&
        belongsToFamily(resource.data.famille_id);
    }

    // PRÉSENCES
    match /presences/{presenceId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated() && hasRole('mentor');
      allow delete: if isAuthenticated() && hasRole('berger');
    }

    // DOCUMENTS
    match /documents/{documentId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create, update, delete: if isAuthenticated() &&
        hasRole('adjoint_berger') &&
        belongsToFamily(request.resource.data.famille_id);
    }

    // SUJETS DE PRIÈRE
    match /sujets_priere/{sujetId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && (
        resource.data.auteur_id == request.auth.uid || isAdmin()
      );
    }

    // TÉMOIGNAGES
    match /temoignages/{temoignageId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && isAdmin();
    }

    // NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && (
        resource.data.auteur_id == request.auth.uid || isAdmin()
      );
    }

    // ========================================
    // NOUVELLES ÂMES
    // ========================================
    match /nouvelles_ames/{nouvelleAmeId} {
      // Tout utilisateur authentifié peut lire/créer/modifier
      // Le filtrage par famille se fait côté client
      allow read, create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // SUIVIS DES NOUVELLES ÂMES
    match /suivis_ames/{suiviId} {
      allow read, create, update, delete: if isAuthenticated();
    }

    // SESSIONS D'ÉVANGÉLISATION
    match /sessions_evangelisation/{sessionId} {
      allow read: if isAuthenticated() && hasRole('mentor');
      allow create, update: if isAuthenticated() && hasRole('adjoint_berger');
      allow delete: if isAuthenticated() && hasRole('berger');
    }

    // SECTEURS D'ÉVANGÉLISATION
    match /secteurs_evangelisation/{secteurId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && hasRole('adjoint_berger');
    }
  }
}
