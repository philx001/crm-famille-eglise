rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserData() {
      return get(/databases/$(database)/documents/utilisateurs/$(request.auth.uid)).data;
    }

    function hasRole(role) {
      let userData = getUserData();
      let roles = ['disciple', 'nouveau', 'mentor', 'adjoint_superviseur', 'superviseur', 'admin'];
      return roles.indexOf(userData.role) >= roles.indexOf(role);
    }

    function belongsToFamily(familleId) {
      let userData = getUserData();
      return userData.role == 'admin' || userData.famille_id == familleId;
    }

    function isAdmin() {
      return isAuthenticated() && getUserData().role == 'admin';
    }

    // FAMILLES : lecture sans auth pour la page de connexion (recherche par nom)
    match /familles/{familleId} {
      allow read: if request.auth == null || (isAuthenticated() && belongsToFamily(familleId));
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // UTILISATEURS
    match /utilisateurs/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        isAdmin() ||
        (hasRole('superviseur') && resource.data.famille_id == getUserData().famille_id) ||
        (hasRole('mentor') && resource.data.mentor_id == request.auth.uid) ||
        (resource.data.famille_id == getUserData().famille_id)
      );

      allow create: if isAuthenticated() && request.auth.uid == userId;

      allow update: if isAuthenticated() && (
        request.auth.uid == userId ||
        (hasRole('superviseur') && resource.data.famille_id == getUserData().famille_id) ||
        isAdmin()
      );

      allow delete: if isAuthenticated() && (
        (hasRole('superviseur') && resource.data.famille_id == getUserData().famille_id) ||
        isAdmin()
      );
    }

    // PROGRAMMES
    match /programmes/{programmeId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create, update: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow delete: if isAuthenticated() &&
        (hasRole('superviseur') || isAdmin()) &&
        belongsToFamily(resource.data.famille_id);
    }

    // PRÉSENCES (création/modification : tout utilisateur authentifié ; l'app restreint la page aux mentor+)
    match /presences/{presenceId} {
      allow read: if isAuthenticated();
      allow create, update: if isAuthenticated();
      allow delete: if isAuthenticated() && (hasRole('superviseur') || isAdmin());
    }

    // DOCUMENTS (fichiers partagés)
    match /documents/{documentId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() && belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && belongsToFamily(resource.data.famille_id) && (
        resource.data.uploaded_by == request.auth.uid
        || hasRole('adjoint_superviseur')
      );
    }

    // SUJETS DE PRIÈRE
    match /sujets_priere/{sujetId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && (
        resource.data.auteur_id == request.auth.uid || isAdmin()
      );
    }

    // TÉMOIGNAGES (auteur ou admin peut modifier/supprimer)
    match /temoignages/{temoignageId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && belongsToFamily(resource.data.famille_id) && (
        resource.data.auteur_id == request.auth.uid || isAdmin()
      );
    }

    // NOTIFICATIONS (auteur, adjoint_superviseur+, ou admin peut modifier/supprimer)
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && belongsToFamily(resource.data.famille_id);
      allow create: if isAuthenticated() &&
        belongsToFamily(request.resource.data.famille_id);
      allow update, delete: if isAuthenticated() && belongsToFamily(resource.data.famille_id) && (
        resource.data.auteur_id == request.auth.uid || hasRole('adjoint_superviseur') || isAdmin()
      );
    }

    // NOUVELLES ÂMES
    match /nouvelles_ames/{nouvelleAmeId} {
      allow read, create, update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }

    // SUIVIS DES NOUVELLES ÂMES
    match /suivis_ames/{suiviId} {
      allow read, create, update, delete: if isAuthenticated();
    }

    // SESSIONS D'ÉVANGÉLISATION
    match /sessions_evangelisation/{sessionId} {
      allow read, create, update, delete: if isAuthenticated();
    }

    // SECTEURS D'ÉVANGÉLISATION
    match /secteurs_evangelisation/{secteurId} {
      allow read, create, update, delete: if isAuthenticated();
    }

    // NOTES DE SUIVI
    match /notes_suivi/{noteId} {
      allow read, create, update, delete: if isAuthenticated();
    }

    // NOTES PERSONNELLES (strictement privées : seul l'auteur peut lire/écrire/supprimer)
    match /notes_personnelles/{noteId} {
      allow read: if isAuthenticated() && resource.data.auteur_id == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.auteur_id == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.auteur_id == request.auth.uid;
    }

    // LOGS (admin uniquement en lecture)
    match /logs_connexion/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
    match /logs_modification/{logId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if false;
    }
  }
}
